<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login y Registro</title>
  <link rel="website icon" type="png" href="..\img\logo.png">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/principal.css">
  <link rel="stylesheet" href="../css/responsive.css">
</head>

<header class="mi-header">
  <div class="header-left1">
    <img src="../img/logo.png" alt="Logo" class="header-logo1">
    <h1 class="header-title1">E.E.S.T.N°5</h1>
  </div>
</header>

<body>

  <div class="container" id="login-container">
    <h2>Sistema De Gestión De Notas</h2>
    <h2>Iniciar Sesión</h2><br>
    <div id="error-msg" class="error"></div>
    <input type="email" id="login-username" placeholder="Correo institucional" required>
    <input type="password" id="login-password" placeholder="Contraseña" required><br>
    <button onclick="login()"><b>Iniciar Sesión</b></button>
    <div class="switch">
      <b>¿No tienes cuenta?</b> <a href="javascript:void(0)" onclick="showRegister()"><b>Registrate</b></a>
    </div>
  </div>

  <div class="container" id="register-container" style="display: none;">
    <h2>Registrar Usuario</h2><br>
    <div id="register-error-msg" class="error"></div>

    <input type="text" id="register-fullname" placeholder="Nombre y Apellido" required>
    <input type="text" id="register-dni" placeholder="DNI" required>

    <input type="email" id="register-username" placeholder="Correo institucional (@eest5.com)" required>

    <div>
      <select id="register-role" required>
        <option value="">Seleccione un rol</option>
        <option value="Profesor">Profesor</option>
        <option value="Preceptor">Preceptor</option>
        <option value="Alumno">Alumno</option>
      </select>
    </div>

    <button onclick="register()"><b>Registrar</b></button>
    <div class="switch">
      <b>¿Ya tienes cuenta?</b> <a href="javascript:void(0)" onclick="showLogin()"><b>Iniciar Sesión</b></a>
    </div>
  </div>

  <script>
    // Muestra el formulario de inicio de sesión y oculta el de registro
    function showLogin() {
      document.getElementById('login-container').style.display = 'block';
      document.getElementById('register-container').style.display = 'none';
      document.getElementById('register-error-msg').innerHTML = '';
    }

    // Muestra el formulario de registro y oculta el de inicio de sesión
    function showRegister() {
      document.getElementById('login-container').style.display = 'none';
      document.getElementById('register-container').style.display = 'block';
      document.getElementById('error-msg').innerHTML = '';
    }

    // Lógica de inicio de sesión
    function login() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;

      if (!username || !password) {
        document.getElementById('error-msg').innerHTML = 'Complete todos los campos';
        return;
      }

      if (username === "admin@eest5.com" && password === "admin123") {
        sessionStorage.setItem("activeUser", JSON.stringify({ email: username, role: "Administrador" }));
        window.location.href = "admin.html";
        return;
      }

      if (!username.endsWith("@eest5.com")) {
        document.getElementById('error-msg').innerHTML = "Debe usar un correo institucional (@eest5.com)";
        return;
      }

      const savedUser = localStorage.getItem(username);
      if (savedUser) {
        const user = JSON.parse(savedUser);
        if (user.password === btoa(password)) {
          sessionStorage.setItem("activeUser", JSON.stringify(user));
          if (user.role === "Profesor") {
            window.location.href = "profesor.html";
          } else if (user.role === "Preceptor") {
            window.location.href = "preceptor.html";
          } else if (user.role === "Alumno") {
            window.location.href = "alumno.html";
          } else if (user.role === "Administrador") {
            window.location.href = "admin.html";
          }
        } else {
          document.getElementById('error-msg').innerHTML = 'Contraseña incorrecta';
        }
      } else {
        document.getElementById('error-msg').innerHTML = 'Usuario no encontrado';
      }
    }

    // Lógica de registro de usuario (ACTUALIZADA)
    function register() {
      const fullname = document.getElementById('register-fullname').value.trim();
      const dni = document.getElementById('register-dni').value.trim();
      const username = document.getElementById('register-username').value.trim();
      const role = document.getElementById('register-role').value;

      if (!fullname || !dni || !username || !role) {
        document.getElementById('register-error-msg').innerHTML = 'Complete todos los campos';
        return;
      }

      if (!username.endsWith("@eest5.com")) {
        document.getElementById('register-error-msg').innerHTML = "Debe usar un correo institucional (@eest5.com)";
        return;
      }

      const pendingUsers = JSON.parse(localStorage.getItem("pendingUsers")) || [];
      // Se almacena la solicitud con los nuevos datos
      pendingUsers.push({
        username,
        fullname,
        dni,
        role,
        requestedAt: new Date().toISOString()
      });
      localStorage.setItem("pendingUsers", JSON.stringify(pendingUsers));

      alert("Tu solicitud de registro fue enviada al administrador. Espera su aprobación.");
      showLogin();
    }

    // Permite enviar formularios con la tecla Enter
    document.addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        const loginVisible = document.getElementById('login-container').style.display !== "none";
        if (loginVisible) {
          login();
        } else {
          register();
        }
      }
    });

    window.history.pushState(null, null, window.location.href);
    window.onpopstate = function() {
      window.history.go(1);
      window.location.href = "principal.html";
    };
  </script>

</body>

</html>