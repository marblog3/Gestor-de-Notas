<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administración</title>
  <link rel="website icon" type="png" href="..\img\logo.png">
  <!-- Estilos principales -->
<link rel="stylesheet" href="../css/base.css">
<link rel="stylesheet" href="../css/admin.css">
<link rel="stylesheet" href="../css/responsive.css">
</head>

<!-- Encabezado principal con logo y botón de cierre de sesión -->
<header class="main-header">
  <div class="header-left">
    <img src="../img/logo.png" alt="Logo" class="header-logo">
    <h1 class="header-title">E.E.S.T.N°5</h1>
  </div>
  
  <!-- Botón de cierre de sesión -->
  <button class="logout-icon" onclick="logout()">

    <div class="sign"><svg viewBox="0 0 512 512">
        <path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9
     406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7
      15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32
       32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"></path>
      </svg></div>

    <div class="text">Logout</div>
  </button>
</header>

<body>


  <div class="boletin-container">
    <h1>PANEL DE ADMINISTRACIÓN</h1>
    <!-- Tabla de usuarios registrados -->
    <h2 class="titulo-2" >Usuarios registrados</h2>
    <table class="boletin" id="usersTable">
      <thead>
        <tr>
          <th>Correo</th>
          <th>Rol</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Botón para crear nuevos usuarios -->
    <div class="contenedor-botones">
      <button onclick="createUser()"><b>➕ Crear Usuario</b></button>
    </div>

    <!-- Panel de notificaciones con solicitudes de registro -->
    <div id="notificationPanel" class="notification-panel">
      <h3 onclick="toggleSolicitudes()" class="toggle-title">
        Solicitudes de Registro <span id="flecha">⬇</span>
      </h3>
      <div id="solicitudesContent" style="display:none;">
        <ul id="pendingList"></ul>
      </div>
    </div>

<div class="column-layout-container">

  <div class="form-container">
        <h2>Asignar alumno a curso</h2>
        <form id="asignarAlumnoForm">
            <div class="form-group">
                <label for="alumnoSelect">Alumno:</label>
                <select id="alumnoSelect" name="alumnoSelect" required>
                </select>
            </div>
            
            <div class="form-group">
                <label for="anioInput">Año:</label>
                <input type="number" id="anioInput" name="anioInput" placeholder="Ej: 5to" class="input-2" required>
            </div>
            
            <div class="form-group">
                <label for="divisionInput">División:</label>
                <input type="text" id="divisionInput" name="divisionInput" placeholder="Ej: 2da" class="input-2" required>
            </div>

            <div class="form-group">
                <label for="especialidadInput">Especialidad:</label>
                <input type="text" id="especialidadInput" name="especialidadInput" placeholder="Ej: Informática" class="input-2" required>
            </div>
            
            <div class="form-group">
                <label for="cursoSelectAlumno">Curso:</label>
                <select id="cursoSelectAlumno" name="cursoSelectAlumno" required>
                    </select>
            </div>

            <button type="submit">Asignar Alumno</button>
        </form>
    </div>

    <div class="form-container">
        <h2>Asignar profesor a curso</h2>
        <form id="asignarProfesorForm">
            <div class="form-group">
                <label for="profesorSelect">Profesor:</label>
                <select id="profesorSelect" name="profesorSelect" required>
                </select>
            </div>
            <div class="form-group">
                      <label for="materiaSelectProfesor">Materia:</label>
                      <select id="materiaSelectProfesor" name="materiaSelectProfesor" required>
                      </select>
            </div>

            <div class="form-group">
                <label for="cursoSelectProfesor">Curso:</label>
                <select id="cursoSelectProfesor" name="cursoSelectProfesor" required>
                </select>
            </div>

            <button type="submit">Asignar Profesor</button>
        </form>
    </div>

    

</div>

  <script>
    /* ------------------------------------------
       FUNCIÓN: Mostrar/Ocultar solicitudes pendientes
       ------------------------------------------ */
    function toggleSolicitudes() {
      const content = document.getElementById("solicitudesContent");
      const flecha = document.getElementById("flecha");
      if (content.style.display === "none") {
        content.style.display = "block";
        flecha.textContent = "⬆";
      } else {
        content.style.display = "none";
        flecha.textContent = "⬇";
      }
    }

    /* ------------------------------------------
       FUNCIÓN: Cerrar sesión del usuario activo
       ------------------------------------------ */
    function logout() {
      sessionStorage.removeItem("activeUser"); // Eliminamos la sesión actual
      window.location.href = "principal.html"; // Redirección a login
    }

    /* ------------------------------------------
       FUNCIÓN: Cargar usuarios desde localStorage
       ------------------------------------------ */
    function cargarUsuarios() {
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = "";

      // Recorremos todos los usuarios almacenados
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key === "pendingUsers") continue; // Excluye solicitudes pendientes
        const user = JSON.parse(localStorage.getItem(key));
        if (!user || !user.role) continue; // Evita registros inválidos

        // Crear fila con datos del usuario
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${user.email || user.username}</td>
          <td>${user.role}</td>
          <td>
            <button class="accion-boton-1" onclick="editUser('${key}')">Editar</button>
            <button class="accion-boton" onclick="deleteUser('${key}')">Eliminar</button>
          </td>
        `;
        tbody.appendChild(row);
      }
      cargarSelects(); // Refresca los selects de asignación
    }

    /* ------------------------------------------
       FUNCIÓN: Crear un nuevo usuario
       ------------------------------------------ */
    function createUser() {
      const email = prompt("Correo institucional:");
      if (!email || !email.endsWith("@eest5.com")) {
        alert("Debe ingresar un correo válido (@eest5.com)");
        return;
      }
      const password = prompt("Contraseña:");
      const role = prompt("Rol (Profesor, Preceptor, Alumno, Administrador):");

      const user = { email, password: btoa(password), role };
      localStorage.setItem(email, JSON.stringify(user)); // Guardar usuario en localStorage
      cargarUsuarios();
    }

    /* ------------------------------------------
       FUNCIÓN: Editar el rol de un usuario
       ------------------------------------------ */
    function editUser(email) {
      const user = JSON.parse(localStorage.getItem(email));
      const newRole = prompt("Nuevo rol (Profesor, Preceptor, Alumno, Administrador):", user.role);
      user.role = newRole;
      localStorage.setItem(email, JSON.stringify(user));
      cargarUsuarios();
    }

    /* ------------------------------------------
       FUNCIÓN: Eliminar usuario
       ------------------------------------------ */
    function deleteUser(email) {
      if (confirm("¿Seguro que quieres eliminar este usuario?")) {
        localStorage.removeItem(email);
        cargarUsuarios();
      }
    }

    /* ------------------------------------------
       FUNCIÓN: Cargar selects de profesores y alumnos
       ------------------------------------------ */
    function cargarSelects() {
      const profesorSelect = document.getElementById("profesorSelect");
      const alumnoSelect = document.getElementById("alumnoSelect");
      profesorSelect.innerHTML = "";
      alumnoSelect.innerHTML = "";

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key === "pendingUsers") continue;
        const user = JSON.parse(localStorage.getItem(key));
        if (user.role === "Profesor") {
          profesorSelect.innerHTML += `<option value="${user.email || user.username}">${user.email || user.username}</option>`;
        }
        if (user.role === "Alumno") {
          alumnoSelect.innerHTML += `<option value="${user.email || user.username}">${user.email || user.username}</option>`;
        }
      }
    }

    /* ------------------------------------------
       FUNCIÓN: Asignar materia a profesor
       ------------------------------------------ */
    function asignarMateria() {
      const profesor = document.getElementById("profesorSelect").value;
      const materia = document.getElementById("materiaInput").value;
      if (!profesor || !materia) return alert("Seleccione profesor y materia");

      const li = document.createElement("li");
      li.textContent = `${profesor} → ${materia}`;
      document.getElementById("materiasList").appendChild(li);
    }

    /* ------------------------------------------
       FUNCIÓN: Asignar alumno a curso/especialidad
       ------------------------------------------ */
    function asignarAlumno() {
      const alumno = document.getElementById("alumnoSelect").value;
      const anio = document.getElementById("anioInput").value;
      const division = document.getElementById("divisionInput").value;
      const especialidad = document.getElementById("especialidadInput").value;

      if (!alumno || !anio || !division || !especialidad) return alert("Complete todos los campos");

      const li = document.createElement("li");
      li.textContent = `${alumno} → Año ${anio}, División ${division}, Especialidad ${especialidad}`;
      document.getElementById("alumnosList").appendChild(li);
    }

    /* ------------------------------------------
       FUNCIÓN: Cargar solicitudes pendientes
       ------------------------------------------ */
    function cargarSolicitudes() {
      const pendingList = document.getElementById("pendingList");
      pendingList.innerHTML = "";
      const pendingUsers = JSON.parse(localStorage.getItem("pendingUsers")) || [];

      // Renderizar solicitudes en lista
      pendingUsers.forEach((user, principal) => {
        const date = new Date(user.requestedAt).toLocaleString();
        const li = document.createElement("li");
        li.style.marginBottom = "8px";
        li.style.padding = "6px";
        li.style.borderBottom = "1px solid #ddd";
        li.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <div style="flex:1;">
              <b>${user.username}</b> <span style="font-size:12px;color:#666"> (Rol: ${user.role})</span>
              <div style="font-size:12px;color:#666">${date}</div>
            </div>
            <div style="flex-shrink:0; display:flex; gap:6px;">
              <button onclick="aprobarUsuario(${principal})">Aprobar</button>
              <button onclick="rechazarUsuario(${principal})">Rechazar</button>
            </div>
          </div>
        `;
        pendingList.appendChild(li);
      });
    }

    /* ------------------------------------------
       FUNCIÓN: Aprobar solicitud de usuario
       ------------------------------------------ */
    function aprobarUsuario(principal) {
      const pendingUsers = JSON.parse(localStorage.getItem("pendingUsers")) || [];
      const userReq = pendingUsers[principal];
      const rawPass = prompt(`Asignar contraseña para ${userReq.username} (esta será la contraseña que usará):`);
      if (rawPass === null || rawPass.trim() === "") {
        alert("Aprobación cancelada: debe ingresar una contraseña para el usuario.");
        return;
      }
      // Crear objeto usuario aprobado
      const user = { email: userReq.username, username: userReq.username, role: userReq.role, password: btoa(rawPass) };
      localStorage.setItem(user.email, JSON.stringify(user));
      pendingUsers.splice(principal, 1); // Eliminar de pendientes
      localStorage.setItem("pendingUsers", JSON.stringify(pendingUsers));
      cargarUsuarios();
      cargarSolicitudes();
    }

    /* ------------------------------------------
       FUNCIÓN: Rechazar solicitud de usuario
       ------------------------------------------ */
    function rechazarUsuario(principal) {
      const pendingUsers = JSON.parse(localStorage.getItem("pendingUsers")) || [];
      pendingUsers.splice(principal, 1);
      localStorage.setItem("pendingUsers", JSON.stringify(pendingUsers));
      cargarSolicitudes();
    }

    // Inicialización al cargar la página
    cargarUsuarios();
    cargarSolicitudes();
  </script>
</body>
</html>
