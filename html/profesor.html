<!DOCTYPE html>
<html lang="es">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>PLANILLA DE CALIFICACIONES</title>
        <link rel="website icon" type="png" href="..\img\logo.png">
        <!-- Estilos principales -->
<link rel="stylesheet" href="../css/base.css">
<link rel="stylesheet" href="../css/profesor.css">
<link rel="stylesheet" href="../css/responsive.css">
</head>

<!-- Encabezado principal -->
<header class="main-header">
        <div class="header-left">
                <img src="../img/logo.png" alt="Logo" class="header-logo">
                <h1 class="header-title">E.E.S.T.N°5</h1>
        </div>
<!-- Botón de cierre de sesión -->
  <button class="logout-icon" onclick="logout()">

    <div class="sign"><svg viewBox="0 0 512 512">
        <path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9
     406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7
      15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32
       32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"></path>
      </svg></div>

    <div class="text">Logout</div>
</header>

<body>

        <script>
                // --- VALIDACIÓN DE SESIÓN ---
                const activeUser = sessionStorage.getItem("activeUser");
                if (!activeUser) {
                        window.location.href = "principal.html";
                }
        </script>

        <!-- Contenedor general de la planilla -->
        <div class="boletin-container" id="boletin">
                <h1 class="title-2">PLANILLA DE CALIFICACIONES</h1>

                <!-- Datos generales de la cursada -->
                <div>
                        <table>
                                <tr>
                                        <td class="td-1"><p>CICLO LECTIVO:</p>
                                                <select id="register-role" class="select" required>
                                                        <option value="">Seleccionar ciclo</option>
                                                        <option>2025</option>
                                                        <option>2024</option>
                                                        <option>2023</option>
                                                        <option>2022</option>
                                                </select>
                                        </td>
                                        <td class="td-1"><p>MATERIA:</p>
                                                <span id="materia-seleccionada" class="select-1"><p>Seleccionar materia</p></span>
                                                <ul class="menu-materia" id="menu-materia">
                                                        <li>
                                                                <a href="#">Aúlica ▸</a>
                                                                <ul>
                                                                        <li><a href="#"
                                                                                        data-materia="Matemáticas">Matemáticas</a>
                                                                        </li>
                                                                        <li><a href="#" data-materia="Lengua">Lengua</a>
                                                                        </li>
                                                                        <li><a href="#"
                                                                                        data-materia="Historia">Historia</a>
                                                                        </li>
                                                                        <li><a href="#" data-materia="Física">Física</a>
                                                                        </li>
                                                                </ul>
                                                        </li>
                                                        <li>
                                                                <a href="#">Taller ▸</a>
                                                                <ul>
                                                                        <li><a href="#"
                                                                                        data-materia="Informática">Informática</a>
                                                                        </li>
                                                                        <li><a href="#"
                                                                                        data-materia="Construcciones">Construcciones</a>
                                                                        </li>
                                                                        <li><a href="#"
                                                                                        data-materia="Electromecánica">Electromecánica</a>
                                                                        </li>
                                                                        <li><a href="#"
                                                                                        data-materia="Química">Química</a>
                                                                        </li>
                                                                </ul>
                                                        </li>
                                                </ul>
                                        </td>


                                        <td class="td-1"><p>PROFESOR/A:</p><input type="text" class="input-1"></td>
                                        <td class="td-1"><p>D.N.I:<p><input type="text" id="dni" class="input-1"></td>
                                </tr>
                                <tr>
                                        <td class="td-1"><p>AÑO:</p>
                                                <select id="register-role" required class="select">
                                                        <option value="">Seleccionar año</option>
                                                        <option>4to</option>
                                                        <option>5to</option>
                                                        <option>6to</option>
                                                        <option>7mo</option>
                                                </select>
                                        </td>
                                        <td class="td-1"><P>DIVISIÓN:</P>
                                                <select id="register-role" required class="select">
                                                        <option value="">Seleccionar división</option>
                                                        <option>1ra</option>
                                                        <option>2da</option>
                                                        <option>3ra</option>
                                                        <option>4ta</option>
                                                </select>
                                        </td>
                                        <td class="td-1"><P>TURNO:</P>
                                                <select id="register-role" required class="select">
                                                        <option value="">Seleccionar turno</option>
                                                        <option>Mañana</option>
                                                        <option>Tarde</option>
                                                        <option>Vespertino</option>
                                                </select>
                                        </td>
                                        <td class="td-1"><p>PRECEPTOR/A:</p><input type="text" class="input-1"></td>
                                </tr>
                        </table>
                </div>

                <!-- Tabla de calificaciones -->
                <div class="tabla-scroll">
                        <table class="tabla-3">
                                <h3>MATERIAS PENDIENTES DE APROBACIÓN Y ACREDITACIÓN - INTENSIFICACIÓN</h3>
                                <thead>
                                        <tr>
                                                <th rowspan="2">N° DE ORDEN</th>
                                                <th rowspan="2">APELLIDOS Y NOMBRES DEL ESTUDIANTE</th>
                                                <th colspan="4">1° CUATRIMESTRE</th>
                                                <th colspan="5">2° CUATRIMESTRE</th>
                                                <th colspan="2">INTENSIFICACIÓN</th>
                                                <th rowspan="2">CALIFICACIÓN FINAL</th>
                                        </tr>
                                        <tr>
                                                <th>CALIFICACIONES/VALORACIONES PARCIALES</th>
                                                <th>1º VALORACIÓN PRELIMINAR</th>
                                                <th>CALIFICACIÓN 1º CUATRIMESTRE</th>
                                                <th>INASISTENCIAS DEL 1º CUATRIMESTRE</th>
                                                <th>CALIFICACIONES/VALORACIONES PARCIALES</th>
                                                <th>2º VALORACIÓN PRELIMINAR</th>
                                                <th>CALIFICACIÓN 2º CUATRIMESTRE</th>
                                                <th>INTENSIFICACIÓN 1º CUATRIMESTRE</th>
                                                <th>INASISTENCIAS DEL 2º CUATRIMESTRE</th>
                                                <th>DICIEMBRE</th>
                                                <th>FEBRERO</th>
                                        </tr>
                                </thead>
                                <tbody id="tabla-estudiantes">
                                        <!-- Filas de estudiantes generadas dinámicamente -->
                                </tbody>
                        </table>
                </div>

                <!-- Contenedor de botones de acción -->
                <div id="botones" class="contenedor-botones">
                        <button id="agregarFilaBtn"><b>AGREGAR ESTUDIANTE</b></button>
                        <button id="guardarBtn"><b>GUARDAR</b></button>
                        <button id="modificarBtn" style="display:none;"><b>MODIFICAR</b></button>
                        <button id="exportarBtn" class="btn-exportar"><b>EXPORTAR A EXCEL</b></button>
                       
                </div>
        <!-- Reporte de resultados -->
        <div id="reporte" class="reporte-container">
                <div class="reporte-encabezado">
                        <h3>REPORTE DE RESULTADOS</h3>
                </div>
        
                <div class="reporte-fila">
                        <div class="reporte-columna">Promedio General:</div>
                        <div class="reporte-columna" id="promedio-general">-</div>
                </div>
        
                <div class="reporte-fila">
                        <div class="reporte-columna">Porcentaje de Aprobados:</div>
                        <div class="reporte-columna" id="porcentaje-aprobados">-</div>
                </div>
        </div>



                <script>
                        function crearFilaEstudiante() {
                                return `
    <tr>
        <td><span class="orden"></span></td>
        <td><input type="text" name="nombre" maxlength="35" class="nota"></td>
        ${Array(11).fill('<td><input type="number" min="1" max="10" class="nota" maxlength="2"></td>').join('')}
        <td class="final-container">
            <input type="number" min="1" max="10" class="nota" maxlength="2">
            <span class="remove-row">X</span>
        </td>
    </tr>`;
                        }



                        // --- Reordenar números de filas ---
                        function actualizarOrden() {
                                document.querySelectorAll("#tabla-estudiantes tr").forEach((tr, index) => {
                                        const span = tr.querySelector(".orden");
                                        if (span) span.textContent = index + 1;
                                });
                        }

                        // --- Validaciones ---
                        function aplicarValidaciones() {
                                // DNI: solo números y formato 99.999.999
                                const dniInput = document.getElementById("dni");
                                if (dniInput) {
                                        dniInput.addEventListener("input", (e) => {
                                                e.target.value = e.target.value.replace(/[^0-9.]/g, "");
                                                if (!/^\d{0,2}(\.\d{0,3}(\.\d{0,3})?)?$/.test(e.target.value)) {
                                                        e.target.value = e.target.value.slice(0, -1);
                                                }
                                        });
                                }

                                // Texto: sin números
                                document.querySelectorAll("input[type='text']").forEach(inp => {
                                        if (inp.id !== "dni") {
                                                inp.addEventListener("input", (e) => {
                                                        e.target.value = e.target.value.replace(/[0-9]/g, "");
                                                        if (e.target.value.length > 35) {
                                                                e.target.value = e.target.value.slice(0, 35);
                                                        }
                                                });
                                        }
                                });

                                // Números: solo del 1 al 10
                                document.querySelectorAll(".tabla-3 input[type='number']").forEach(inp => {
                                        inp.addEventListener("keydown", (e) => {
                                                if (["Backspace", "Tab", "Enter", "ArrowLeft", "ArrowRight"].includes(e.key)) return;
                                                if (!/[0-9]/.test(e.key)) {
                                                        e.preventDefault();
                                                        return;
                                                }
                                                let nextVal = e.target.value + e.key;
                                                let num = parseInt(nextVal, 10);
                                                if (num < 1 || num > 10) {
                                                        e.preventDefault();
                                                }
                                        });
                                });
                        }

                        // --- Inicializar ---
                        document.addEventListener('DOMContentLoaded', function () {
                                const tablaEstudiantes = document.getElementById('tabla-estudiantes');
                                for (let i = 0; i < 12; i++) {
                                        tablaEstudiantes.insertAdjacentHTML("beforeend", crearFilaEstudiante());
                                }
                                actualizarOrden();
                                configurarNavegacion();
                                aplicarValidaciones();
                        });

                        // --- Botones ---
                        const guardarBtn = document.getElementById("guardarBtn");
                        const modificarBtn = document.getElementById("modificarBtn");
                        const boletin = document.getElementById("boletin");
                        const agregarFilaBtn = document.getElementById("agregarFilaBtn");

                        // Agregar fila
                        agregarFilaBtn.addEventListener("click", () => {
                                const tablaEstudiantes = document.getElementById('tabla-estudiantes');
                                tablaEstudiantes.insertAdjacentHTML("beforeend", crearFilaEstudiante());
                                actualizarOrden();
                                configurarNavegacion();
                                aplicarValidaciones();
                        });

                        // Guardar
                        guardarBtn.addEventListener("click", () => {
                                document.querySelectorAll("select").forEach(select => {
                                        const valor = getSelectText(select);
                                        const span = document.createElement("span");
                                        span.textContent = valor;
                                        span.className = "select-preview";
                                        span.dataset.options = select.innerHTML;
                                        select.replaceWith(span);
                                });
                                boletin.classList.add("vista-previa");
                                guardarBtn.style.display = "none";
                                modificarBtn.style.display = "inline-block";
                                exportarBtn.style.display = "inline-block";
                        });

                        // Modificar
                        modificarBtn.addEventListener("click", () => {
                                document.querySelectorAll(".select-preview").forEach(span => {
                                        const valor = span.textContent;
                                        const select = document.createElement("select");
                                        select.innerHTML = span.dataset.options || "";
                                        for (let opt of select.options) {
                                                if (opt.text === valor) {
                                                        opt.selected = true;
                                                        break;
                                                }
                                        }
                                        span.replaceWith(select);
                                });
                                boletin.classList.remove("vista-previa");
                                guardarBtn.style.display = "inline-block";
                                modificarBtn.style.display = "none";
                                exportarBtn.style.display = "inline-block";
                                aplicarValidaciones();
                        });

                        // --- Navegación con Enter ---
                        function configurarNavegacion() {
                                const inputsNotas = document.querySelectorAll("input[type='number'], input[type='text']");
                                inputsNotas.forEach((input) => {
                                        input.removeEventListener("keydown", navegarConEnter);
                                        input.addEventListener("keydown", navegarConEnter);
                                });
                        }
                        function navegarConEnter(event) {
                                if (event.key === "Enter") {
                                        event.preventDefault();
                                        const inputs = document.querySelectorAll("input[type='number'], input[type='text']");
                                        const current = Array.from(inputs).indexOf(event.target);
                                        const next = inputs[current + 1];
                                        if (next) next.focus();
                                }
                        }

                        // --- Eliminar fila ---
                        document.addEventListener("click", (e) => {
                                if (e.target.classList.contains("remove-row")) {
                                        e.target.closest("tr").remove();
                                        actualizarOrden();
                                }
                        });

                        // --- Bloquear botón atrás ---
                        window.history.pushState(null, null, window.location.href);
                        window.onpopstate = function () {
                                window.history.go(-1);
                                window.location.href = "principal.html";
                        };

                        // --- Selección de materia ---
                        document.querySelectorAll(".menu-materia a[data-materia]").forEach(link => {
                                link.addEventListener("click", (e) => {
                                        e.preventDefault();
                                        const materia = e.target.dataset.materia;
                                        document.getElementById("materia-seleccionada").textContent = materia;
                                });
                        });

                        // --- Selección de materia ---
                        document.querySelectorAll(".menu-materia a[data-materia]").forEach(link => {
                                link.addEventListener("click", (e) => {
                                        e.preventDefault();
                                        const materia = e.target.dataset.materia;

                                        // Mostrar materia en el span
                                        const spanMateria = document.getElementById("materia-seleccionada");
                                        spanMateria.textContent = materia;

                                        // Ocultar menú cascada
                                        document.getElementById("menu-materia").style.display = "none";
                                });
                        });

                        // --- Función para obtener la materia seleccionada ---
                        function getMateriaSeleccionada() {
                                return document.getElementById("materia-seleccionada").textContent || "";
                        }


                </script>

                <!-- Script externo -->
                <script src="../js/gestion.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

                <!-- Exportar a Excel -->
                <script>
                        const exportarBtn = document.getElementById("exportarBtn");

                        function getSelectText(el) {
                                if (!el) return "";
                                if (el.tagName === "SELECT") {
                                        return el.options[el.selectedIndex]?.text || "";
                                }
                                return el.textContent || "";
                        }

                        exportarBtn.addEventListener("click", async () => {
                                let ciclo = getSelectText(document.querySelector("td:nth-child(1) select, td:nth-child(1) .select-preview"));
                                let materia = getMateriaSeleccionada();
                                let profesor = document.querySelector("td:nth-child(3) input")?.value || "";
                                let dni = document.querySelector("#dni")?.value || "";
                                let anio = getSelectText(document.querySelector("tr:nth-child(2) td:nth-child(1) select, tr:nth-child(2) td:nth-child(1) .select-preview"));
                                let division = getSelectText(document.querySelector("tr:nth-child(2) td:nth-child(2) select, tr:nth-child(2) td:nth-child(2) .select-preview"));
                                let turno = getSelectText(document.querySelector("tr:nth-child(2) td:nth-child(3) select, tr:nth-child(2) td:nth-child(3) .select-preview"));
                                let preceptor = document.querySelector("tr:nth-child(2) td:nth-child(4) input")?.value || "";

                                // Encabezados generales
                                let headerGeneral = [
                                        "CICLO LECTIVO", "MATERIA", "PROFESOR/A", "D.N.I",
                                        "AÑO", "DIVISIÓN", "TURNO", "PRECEPTOR/A"
                                ];
                                let datosGenerales = [
                                        ciclo, materia, profesor, dni, anio, division, turno, preceptor
                                ];

                                // Encabezados de alumnos
                                let headerAlumnos = [
                                        "N° DE ORDEN",
                                        "APELLIDOS Y NOMBRES DEL ESTUDIANTE",
                                        "CALIFICACIONES/VALORACIONES PARCIALES (1ºC)",
                                        "1º VALORACIÓN PRELIMINAR",
                                        "CALIFICACIÓN 1º CUATRIMESTRE",
                                        "INASISTENCIAS 1ºC",
                                        "CALIFICACIONES/VALORACIONES PARCIALES (2ºC)",
                                        "2º VALORACIÓN PRELIMINAR",
                                        "CALIFICACIÓN 2º CUATRIMESTRE",
                                        "INASISTENCIAS 2ºC",
                                        "INTENSIFICACIÓN 1ºC",
                                        "DICIEMBRE",
                                        "FEBRERO",
                                        "CALIFICACIÓN FINAL"
                                ];

                                // Datos de alumnos
                                let filasAlumnos = [];
                                document.querySelectorAll(".tabla-3 tbody tr").forEach(tr => {
                                        let orden = tr.querySelector(".orden")?.textContent || "";
                                        let celdas = tr.querySelectorAll("input");
                                        let fila = [
                                                orden,
                                                celdas[0]?.value || "",
                                                celdas[1]?.value || "",
                                                celdas[2]?.value || "",
                                                celdas[3]?.value || "",
                                                celdas[4]?.value || "",
                                                celdas[5]?.value || "",
                                                celdas[6]?.value || "",
                                                celdas[7]?.value || "",
                                                celdas[8]?.value || "",
                                                celdas[9]?.value || "",
                                                celdas[10]?.value || "",
                                                celdas[11]?.value || "",
                                                celdas[12]?.value || ""
                                        ];
                                        filasAlumnos.push(fila);
                                });

                                // Crear workbook
                                let workbook = new ExcelJS.Workbook();
                                let worksheet = workbook.addWorksheet("Planilla");

                                worksheet.addRow(headerGeneral);
                                worksheet.addRow(datosGenerales);
                                worksheet.addRow([]);
                                worksheet.addRow([]);
                                worksheet.addRow(headerAlumnos);
                                filasAlumnos.forEach(fila => worksheet.addRow(fila));

                                // Estilos
                                worksheet.eachRow({ includeEmpty: false }, function (row, rowNumber) {
                                        row.eachCell(function (cell) {
                                                cell.alignment = { vertical: "middle", horizontal: "center", wrapText: true };
                                                cell.border = {
                                                        top: { style: "thin" },
                                                        left: { style: "thin" },
                                                        bottom: { style: "thin" },
                                                        right: { style: "thin" }
                                                };
                                        });
                                        if (rowNumber === 1 || rowNumber === 5) {
                                                row.eachCell(cell => { cell.font = { bold: true }; });
                                        }
                                });

                                worksheet.columns.forEach(column => { column.width = 30; });
                                worksheet.getColumn(2).width = 35;
                                worksheet.getColumn(3).width = 30;
                                worksheet.getColumn(8).width = 30;

                                const buffer = await workbook.xlsx.writeBuffer();
                                saveAs(new Blob([buffer], { type: "application/octet-stream" }), "Planilla_Calificaciones.xlsx");
                        });

                        // --- Calcular promedios y aprobados ---
                        function calcularReporte() {
                                const filas = document.querySelectorAll("#tabla-estudiantes tr");
                                let sumaGeneral = 0, cantidadAlumnos = 0, aprobados = 0;

                                filas.forEach(tr => {
                                        const inputs = tr.querySelectorAll("input[type='number']");
                                        if (inputs.length > 0) {
                                                let suma = 0, contador = 0;

                                                // Tomamos todas las notas menos la última (final)
                                                for (let i = 0; i < inputs.length - 1; i++) {
                                                        if (inputs[i].value) {
                                                                suma += parseFloat(inputs[i].value);
                                                                contador++;
                                                        }
                                                }

                                                // Calcular promedio individual
                                                if (contador > 0) {
                                                        let promedio = (suma / contador).toFixed(2);

                                                        // Mostrar el promedio en la columna "Calificación Final"
                                                        inputs[inputs.length - 1].value = promedio;

                                                        sumaGeneral += parseFloat(promedio);
                                                        cantidadAlumnos++;

                                                        // Aprobados (>=7)
                                                        if (promedio >= 7) aprobados++;
                                                }
                                        }
                                });

                                // Promedio general de la clase
                                let promedioGeneral = cantidadAlumnos > 0 ? (sumaGeneral / cantidadAlumnos).toFixed(2) : "-";
                                document.getElementById("promedio-general").textContent = promedioGeneral;

                                // Porcentaje de aprobados
                                let porcentaje = cantidadAlumnos > 0 ? ((aprobados / cantidadAlumnos) * 100).toFixed(1) + "%" : "-";
                                document.getElementById("porcentaje-aprobados").textContent = porcentaje;

                                // Ocultamos lista de promedios individuales en el reporte
                                document.getElementById("promedios-individuales").innerHTML = "";
                        }


                        // Botón para actualizar reporte automáticamente
                        const reporteBtn = document.createElement("button");
                        reporteBtn.innerHTML = "<b>GENERAR REPORTE</b>";
                        reporteBtn.onclick = calcularReporte;
                        document.getElementById("botones").appendChild(reporteBtn);
                        reporteBtn.id = "btn-reporte";

                </script>


</body>

</html>